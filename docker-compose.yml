services:
  valhalla:
    build: ./valhalla
    container_name: osm-valhalla
    volumes:
      - ./data/pbf:/data/pbf
      - valhalla-tiles:/data/valhalla
    ports:
      - '8002:8002'
    environment:
      - BUILD_TILES=true
    restart: unless-stopped

  vroom:
    build: ./vroom
    container_name: osm-vroom
    depends_on:
      - valhalla
    environment:
      - VALHALLA_URL=http://valhalla:8002
    ports:
      - '3000:3000'
    restart: unless-stopped

  backend:
    build: ./backend
    container_name: osm-backend
    depends_on:
      - vroom
    environment:
      - VROOM_URL=http://vroom:3000
      - VALHALLA_URL=http://valhalla:8002
    volumes:
      - ./data/pois:/data/pois
    ports:
      - '3001:3001'
    restart: unless-stopped

  frontend:
    build: ./frontend
    container_name: osm-frontend
    depends_on:
      - backend
    restart: unless-stopped

  nginx:
    build: ./nginx
    container_name: osm-nginx
    depends_on:
      - frontend
      - backend
    ports:
      - '8080:80'
    restart: unless-stopped

  nominatim:
    image: mediagis/nominatim:4.4
    container_name: osm-nominatim
    volumes:
      - ./data/pbf:/nominatim/data
      - nominatim-db:/var/lib/postgresql/14/main
    environment:
      - PBF_PATH=/nominatim/data/california-latest.osm.pbf
      - NOMINATIM_PASSWORD=very_secure_password
    ports:
      - '8001:8080'
    restart: unless-stopped
    shm_size: 2gb

volumes:
  valhalla-tiles:
  nominatim-db:
